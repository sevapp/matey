# Matey

Matey - –º–æ–¥—É–ª—å –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∫–æ–Ω—Å–æ–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ —Å —Å—É–±–∫–æ–º–∞–Ω–¥–∞–º–∏, –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏, –æ–ø—Ü–∏—è–º–∏ –∏ —Ñ–ª–∞–≥–∞–º–∏.

–î–≤–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏: _Cli_ –∏ _ComandBuilder_. _Cli_ - —ç—Ç–æ –∫–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π —Ö—Ä–∞–Ω–∏—Ç –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã, –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ. _CommandBuilder_ - —ç—Ç–æ –∫–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã, –¥–æ–±–∞–≤–ª—è—Ç—å –∏—Ö –≤ _Cli_ –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –∏—Ö (–æ–ø—Ü–∏–∏, —Ñ–ª–∞–≥–∏, –∞—Ä–≥—É–º–µ–Ω—Ç—ã, —Å—É–±–∫–æ–º–∞–Ω–¥—ã –∏ —Ç.–¥.).

–ö–æ–º–∞–Ω–¥—ã –º–æ–≥—É—Ç –±—ã—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Å–æ–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

> –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

- [Matey](#matey)
  - [–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ](#–æ–≥–ª–∞–≤–ª–µ–Ω–∏–µ)
  - [–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ](#–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)
    - [–°—Ö–µ–º–∞—Ç–∏—á–Ω—ã–π –ø—Ä–∏–º–µ—Ä](#—Å—Ö–µ–º–∞—Ç–∏—á–Ω—ã–π-–ø—Ä–∏–º–µ—Ä)
    - [–†–∞–±–æ—á–∏–π –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä](#—Ä–∞–±–æ—á–∏–π-–ø—Ä–æ—Å—Ç–æ–π-–ø—Ä–∏–º–µ—Ä)
  - [–ü—Ä–∏–º–µ—Ä](#–ø—Ä–∏–º–µ—Ä)
  - [–ú–∏–¥–ª–≤–∞—Ä—å](#–º–∏–¥–ª–≤–∞—Ä—å)

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –°—Ö–µ–º–∞—Ç–∏—á–Ω—ã–π –ø—Ä–∏–º–µ—Ä

> üîß –û–ø–∏—Å—ã–≤–∞–π—Ç–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã-**–æ–ø—Ü–∏–∏**(–∫–æ—Ç–æ—Ä—ã–µ —Ö—Ä–∞–Ω—è—Ç –∫–∞–∫–æ–µ-—Ç–æ –ø–æ–ª–µ–∑–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ) –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã –≤ –≤–∏–¥–µ

```ts
const argA_1: ICommandArgument = {
  name: 'argA_1',
  description: 'argA_1 description',
  type: ArgumentType.OPTION,
  valueValidator: (val: string) => val.length > 0,
  optionNameRequired: true,
  required: true,
};
```

> üö© –û–ø–∏—Å—ã–≤–∞–π—Ç–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã-**—Ñ–ª–∞–≥–∏**(–Ω–∞–ª–∏—á–∏–µ –∫–æ—Ç–æ—Ä—ã—Ö —Å–∞–º–æ –ø–æ —Å–µ–±–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞) –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã –≤ –≤–∏–¥–µ

```ts
const argA_2: ICommandArgument = {
  name: 'argA_2',
  description: 'argA_2 description',
  type: ArgumentType.FLAG,
  required: false,
};
```

> ‚ö° –û–ø–∏—Å—ã–≤–∞–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –≤–∏–¥–µ

```ts
const cmdA = new CliCommandBuilder()
  .setName('cmdA')
  .setDescription('cmdA description')
  .addArgument(argA_1)
  .addArgument(argA_2)
  .addSubcommand(subA)
  .setHandler(handlerA)
  .build();
```

> üõ°Ô∏è –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π cli –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫ –Ω–µ–º—É –∫–æ–º–∞–Ω–¥—ã –∏ –º–∏–¥–ª–≤–∞—Ä–∏

```ts
const cli = new Cli();
cli
  .addCommand(cmdA)
  .addCommand(cmdB)
  .addCommand(cmdC)
  .use(rexExpA, handlerA)
  .use(rexExpB, handlerB);
```

> üöÄ –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É

```ts
cli.execute`cmdA --argA_1 "Hello" --argA_2 150`;
```

### –†–∞–±–æ—á–∏–π –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä

## –ü—Ä–∏–º–µ—Ä

–ü—É—Å—Ç—å –º—ã —Ö–æ—Ç–∏–º –ø–æ–ª—É—á–∞—Ç—å –∫–æ–º–º–∏—Ç-—Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º –≤ –ø—Ä–æ–µ–∫—Ç–µ –∫–æ–º–∞–Ω–¥–æ–π –≤–∏–¥–∞ _commit generate_ _[--maxTokens] \<number\> [--short]_

```ts
// main.ts
//–¢–£–¢ –ü–†–û–ü–ò–°–ê–¢–¨ –ù–û–†–ú–ê–õ–¨–ù–´–ô –ò–ú–ü–û–†–¢
import { Cli } from '../../mod.ts';
import { commit, generate } from './command.ts';
import { helpMiddleware } from './middleware.ts';

const cli = new Cli();
cli
  .addCommand(commit)
  .addCommand(generate)
  .use(helpMiddleware.pattern, helpMiddleware.handler);

await cli.execute`commit generate --short`;
```

–í—ã–≥–ª—è–¥–∏—Ç –∫–ª–∞—Å—Å–Ω–æ, –≤–µ—Ä–Ω–æ?
–ü–æ—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω _./command.ts_
>–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º [shelly](https://deno.land/x/shelly@v0.1.1/mod.ts) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ _git diff_
>–ê —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é _generateCommit_ –ø—Ä–∏–≤–æ–¥–∏—Ç—å –Ω–µ –±—É–¥–µ–º

```ts
// command.ts
import {
  ArgumentType,
  CliCommandBuilder,
  HandlerArgs,
  ICommandArgument,
} from 'https://deno.land/x/matey/mod.ts';
import { generateCommit } from './generateCommit.ts';
import validateFunctions from '../../src/validateFunctions.ts';

// –û–ø–∏—à–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç-–æ–ø—Ü–∏—é, –æ—Ç–≤–µ—á–∞—é—â—É—é –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
const tokenArgument: ICommandArgument = {
  name: '--maxTokens',
  description: 'Maximum number of tokens to generate',
  type: ArgumentType.OPTION,
  valueValidator: validateFunctions.numberValidate,
  optionNameRequired: true,
  required: false,
};

// –ê—Ä–≥—É–º–µ–Ω—Ç-—Ñ–ª–∞–≥, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–º–º–∏—Ç
const shortArgument: ICommandArgument = {
  name: '--short',
  description: 'Generate short commit message',
  type: ArgumentType.FLAG,
  required: false,
};

// –û–ø–∏—Å—ã–≤–∞–µ–º –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã –∫–æ–º–∞–Ω–¥—ã
const generateHandler = async (args: HandlerArgs) => {
  let { '--maxTokens': maxTokens, '--short': short } = args;
  const diff = await (await shelly('git diff')).stdout;
  maxTokens = short ? '20' : maxTokens || '50';
  const commitMessage = await generateCommit(
    diff,
    parseInt(maxTokens as string, 10)!,
  );
  console.log(commitMessage);
};

// –°–æ–±–∏—Ä–∞–µ–º –Ω–∞—à—É generate –∫–æ–º–∞–Ω–¥—É
export const generate = new CliCommandBuilder()
  .setName('generate')
  .setDescription('Generate commit message based on git diff')
  .addArgument(tokenArgument)
  .addArgument(shortArgument)
  .setHandler(generateHandler)
  .build();

// –ü—É—Å—Ç—å generate —è–≤—è–ª–µ—Ç—Å—è —Å—É–±–∫–æ–º–∞–Ω–¥–æ–π –∫–∞–∫–æ–π-—Ç–æ –≥–ª–∞–≤–Ω–æ–π
// –∫–æ–º–∞–Ω–¥—ã commit
export const commit = new CliCommandBuilder()
  .setName('commit')
  .setDescription('Commit commands')
  .addSubcommand(generate)
  .setHandler((args) => {})
  .build();
```

–í–º–µ—Å—Ç–æ _validateFunctions.numberValidate_ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ—é —Å—Ç—Ä–µ–ª–æ—á–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤–∏–¥–∞ _string => boolean_

## –ú–∏–¥–ª–≤–∞—Ä—å

–ï—Å–ª–∏ –ø–µ—Ä–µ–¥ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã –Ω—É–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∏–¥–ª–≤–∞—Ä—å. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –º–∏–¥–ª–≤–∞—Ä—å –∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–º–∞–Ω–¥—É, –≤–µ—Ä–Ω–∏—Ç–µ _false_ –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –º–∏–¥–ª–≤–∞—Ä–∏.

```ts
//middleware.ts
const helpMiddleware = {
  pattern: / help /,
  handler: (lexemes: ILexeme[]) => {
    const toHelpCmds = lexemes.filter((lexeme) => {
      return lexeme.type === LexemeType.COMMAND;
    }).map((cmd) => cmd.content);
    console.log(`Find commands ${toHelpCmds} `);
    return false;
  },
};
```
